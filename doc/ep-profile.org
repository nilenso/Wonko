* conclusions
- EP api calls are about 15% slower at the 10ms mark with wonko
- They don't seem to affect the 5ms level as much

There are 3 potential reasons for the latency.
1. The JSON serialization done by the java kafka client library is
   synchronous. We should look to make this asynchronous, since we
   might increase the size of the data being serialized, and that
   shouldn't affect latency.
2. The java kafka client library uses an internal buffer to queue up
   records. This implies blocking requests when it gets too many
   requests.
3. Fetching hostname and IP address for metadata. While this cost is
   minimal compared to #1 and #2, it does show up in the profile.

* comparison table
| stat          | without wonko | with wonko | % slower |
|---------------+---------------+------------+----------|
| gb call < 5   |            79 |         67 |   -15.19 |
| gb call < 10  |            90 |         82 |    -8.89 |
| gut call < 5  |            53 |         44 |   -16.98 |
| gut call < 10 |            78 |         71 |    -8.97 |
| gb sp < 5     |            76 |         73 |    -3.95 |
| gb sp < 10    |            90 |         88 |    -2.22 |
| gut sp < 5    |            59 |         53 |   -10.17 |
| gut sp < 10   |            80 |         76 |    -5.00 |
#+TBLFM: $4=($3 - $2)*100/$2;%.2f

| stat          | without wonko | with wonko | wonko | % slower |
|---------------+---------------+------------+-------+----------|
| gb call < 5   |            79 |         74 |       |    -6.33 |
| gb call < 10  |            90 |         83 |       |    -7.78 |
| gut call < 5  |            53 |         65 |       |    22.64 |
| gut call < 10 |            78 |         77 |       |    -1.28 |
| gb sp < 5     |            76 |         62 |       |   -18.42 |
| gb sp < 10    |            90 |         81 |       |   -10.00 |
| gut sp < 5    |            59 |         39 |       |   -33.90 |
| gut sp < 10   |            80 |         63 |       |   -21.25 |
#+TBLFM: $5=($3 - $2)*100/$2;%.2f

* env notes
- using hog driver ep sessions with po-lift and po-model-lift
- collecting stats from api-0-perf, since api-1-perf is a small box
- 25 workers
- ~ 160 requests per second, but this fatigued to about 120 rps towards the end

* raw stats
** stats without wonko
#+begin_src
==================== API COUNTS

          get_user-token_count: 25141 -----------------------------------   OK     [-lt 1000]
      get_user_token_400_count: 0 ---------------------------------------   OK     [-gt 1000]
         get_user_token_400_pc: 0 ---------------------------------------   OK     [-gt 2]
             get_buckets_count: 25196 -----------------------------------   OK     [-lt 1000]
         get_buckets_404_count: 0 ---------------------------------------   OK     [-gt 1000]
            get_buckets_404_pc: 0 ---------------------------------------   OK     [-gt 2]
          confirm_bucket_count: 22600 -----------------------------------   OK     [-lt 1000]
      confirm_bucket_400_count: 44 --------------------------------------   OK     [-gt 1000]
         confirm_bucket_400_pc: 0 ---------------------------------------   OK     [-gt 2]
                   error_count: 0 ---------------------------------------   OK     [-gt 0]

==================== HISTOGRAMS

GB
          0   20079 / 25198    79.68%  79.68%
         5    2658 / 25198    10.55%  90.23%
        10    1055 / 25198    4.19%  94.42%
        15     594 / 25198    2.36%  96.78%
        20     302 / 25198    1.20%  97.98%
        25     147 / 25198    0.58%  98.56%

                   GB-under-10: 90 -------------------------------------- FAIL     [-lt 97]
GUT
          0   13382 / 25145    53.22%  53.22%
         5    6255 / 25145    24.88%  78.10%
        10    2579 / 25145    10.26%  88.35%
        15    1158 / 25145    4.61%  92.96%
        20     554 / 25145    2.20%  95.16%
        25     311 / 25145    1.24%  96.40%

                  GUT-under-10: 78 -------------------------------------- FAIL     [-lt 90]

==================== STORED PROCS

sessions-by-user-token
          0   22942 / 25199    91.04%  91.04%
         5    1330 / 25199    5.28%  96.32%
        10     478 / 25199    1.90%  98.22%
        15     204 / 25199    0.81%  99.03%
        20     107 / 25199    0.42%  99.45%
        25      47 / 25199    0.19%  99.64%

                 sbut-under-10: 96 -------------------------------------- FAIL     [-lt 99]
partition-by-id


/apps/eccentrica/code/bin/status: line 18: [: too many arguments
                 pbid-under-10: -lt 99 ----------------------------------     OK
                            []:
get-buckets-stored-proc
          0   19084 / 25044    76.20%  76.20%
         5    3588 / 25044    14.33%  90.53%
        10    1173 / 25044    4.68%  95.21%
        15     423 / 25044    1.69%  96.90%
        20     171 / 25044    0.68%  97.58%
        25     101 / 25044    0.40%  97.99%

       gb-stored-proc-under-10: 90 -------------------------------------- FAIL     [-lt 99]
get-user-token-sp
          0   15065 / 25305    59.53%  59.53%
         5    5375 / 25305    21.24%  80.77%
        10    2281 / 25305    9.01%  89.79%
        15     982 / 25305    3.88%  93.67%
        20     483 / 25305    1.91%  95.58%
        25     267 / 25305    1.06%  96.63%

               gut-sp-under-10: 80 -------------------------------------- FAIL     [-lt 99]
#+end_src
** stats with wonko
#+begin_src
==================== API COUNTS

          get_user-token_count: 25178 -----------------------------------   OK     [-lt 1000]
      get_user_token_400_count: 0 ---------------------------------------   OK     [-gt 1000]
         get_user_token_400_pc: 0 ---------------------------------------   OK     [-gt 2]
             get_buckets_count: 25234 -----------------------------------   OK     [-lt 1000]
         get_buckets_404_count: 0 ---------------------------------------   OK     [-gt 1000]
            get_buckets_404_pc: 0 ---------------------------------------   OK     [-gt 2]
          confirm_bucket_count: 14614 -----------------------------------   OK     [-lt 1000]
      confirm_bucket_400_count: 33 --------------------------------------   OK     [-gt 1000]
         confirm_bucket_400_pc: 0 ---------------------------------------   OK     [-gt 2]
                   error_count: 1 --------------------------------------- FAIL     [-gt 0]

==================== HISTOGRAMS

GB
          0   16938 / 25236    67.12%  67.12%
         5    3910 / 25236    15.49%  82.61%
        10    1805 / 25236    7.15%  89.76%
        15     945 / 25236    3.74%  93.51%
        20     544 / 25236    2.16%  95.66%
        25     339 / 25236    1.34%  97.01%

                   GB-under-10: 82 -------------------------------------- FAIL     [-lt 97]
GUT
          0   11182 / 25181    44.41%  44.41%
         5    6846 / 25181    27.19%  71.59%
        10    3202 / 25181    12.72%  84.31%
        15    1492 / 25181    5.93%  90.23%
        20     790 / 25181    3.14%  93.37%
        25     459 / 25181    1.82%  95.19%

                  GUT-under-10: 71 -------------------------------------- FAIL     [-lt 90]

==================== STORED PROCS

sessions-by-user-token
          0   22078 / 25237    87.48%  87.48%
         5    1823 / 25237    7.22%  94.71%
        10     672 / 25237    2.66%  97.37%
        15     313 / 25237    1.24%  98.61%
        20     148 / 25237    0.59%  99.20%
        25      71 / 25237    0.28%  99.48%

                 sbut-under-10: 94 -------------------------------------- FAIL     [-lt 99]
partition-by-id


/apps/eccentrica/code/bin/status: line 18: [: too many arguments
                 pbid-under-10: -lt 99 ----------------------------------     OK
                            []:
get-buckets-stored-proc
          0   18310 / 25077    73.02%  73.02%
         5    3914 / 25077    15.61%  88.62%
        10    1359 / 25077    5.42%  94.04%
        15     553 / 25077    2.21%  96.25%
        20     261 / 25077    1.04%  97.29%
        25     111 / 25077    0.44%  97.73%

       gb-stored-proc-under-10: 88 -------------------------------------- FAIL     [-lt 99]
get-user-token-sp
          0   13769 / 25785    53.40%  53.40%
         5    6041 / 25785    23.43%  76.83%
        10    2728 / 25785    10.58%  87.41%
        15    1273 / 25785    4.94%  92.34%
        20     620 / 25785    2.40%  94.75%
        25     347 / 25785    1.35%  96.09%

               gut-sp-under-10: 76 -------------------------------------- FAIL     [-lt 99]
#+end_src
** stats with wonko, and wonko histograms
==================== HISTOGRAMS
#+begin_src
GB
          0   37710 / 50439    74.76%  74.76%
         5    4493 / 50439    8.91%  83.67%
        10    2580 / 50439    5.12%  88.79%
        15    1642 / 50439    3.26%  92.04%
        20    1154 / 50439    2.29%  94.33%
        25     740 / 50439    1.47%  95.80%

                   GB-under-10: 83 -------------------------------------- FAIL     [-lt 97]
GUT
          0   32856 / 50322    65.29%  65.29%
         5    6284 / 50322    12.49%  77.78%
        10    3912 / 50322    7.77%  85.55%
        15    2360 / 50322    4.69%  90.24%
        20    1554 / 50322    3.09%  93.33%
        25     894 / 50322    1.78%  95.11%

                  GUT-under-10: 77 -------------------------------------- FAIL     [-lt 90]
GUT-WONKO
          0   24659 / 25084    98.31%  98.31%
         5     220 / 25084    0.88%  99.18%
        10      81 / 25084    0.32%  99.51%
        15      47 / 25084    0.19%  99.69%
        20      28 / 25084    0.11%  99.80%
        25      12 / 25084    0.05%  99.85%

            GUT-WONKO-under-10: 99 --------------------------------------   OK     [-lt 90]
GB-WONKO
          0   24458 / 25143    97.28%  97.28%
         5     331 / 25143    1.32%  98.59%
        10     160 / 25143    0.64%  99.23%
        15      78 / 25143    0.31%  99.54%
        20      40 / 25143    0.16%  99.70%
        25      31 / 25143    0.12%  99.82%

             GB-WONKO-under-10: 98 --------------------------------------   OK     [-lt 90]
WONKO
          0   178417 / 182783    97.61%  97.61%
         5    1964 / 182783    1.07%  98.69%
        10     903 / 182783    0.49%  99.18%
        15     480 / 182783    0.26%  99.44%
        20     335 / 182783    0.18%  99.63%
        25     215 / 182783    0.12%  99.74%

                WONKO-under-10: 98 --------------------------------------   OK     [-lt 90]

==================== STORED PROCS

sessions-by-user-token
          0   44857 / 50440    88.93%  88.93%
         5    2741 / 50440    5.43%  94.37%
        10    1235 / 50440    2.45%  96.81%
        15     654 / 50440    1.30%  98.11%
        20     327 / 50440    0.65%  98.76%
        25     201 / 50440    0.40%  99.16%

                 sbut-under-10: 94 -------------------------------------- FAIL     [-lt 99]
partition-by-id


/apps/eccentrica/code/bin/status: line 18: [: too many arguments
                 pbid-under-10: -lt 99 ----------------------------------     OK
                            []:
get-buckets-stored-proc
          0   15661 / 25123    62.34%  62.34%
         5    4750 / 25123    18.91%  81.24%
        10    2154 / 25123    8.57%  89.82%
        15     991 / 25123    3.94%  93.76%
        20     537 / 25123    2.14%  95.90%
        25     263 / 25123    1.05%  96.95%

       gb-stored-proc-under-10: 81 -------------------------------------- FAIL     [-lt 99]
get-user-token-sp
          0   10602 / 26769    39.61%  39.61%
         5    6326 / 26769    23.63%  63.24%
        10    3629 / 26769    13.56%  76.79%
        15    2237 / 26769    8.36%  85.15%
        20    1322 / 26769    4.94%  90.09%
        25     736 / 26769    2.75%  92.84%

               gut-sp-under-10: 63 -------------------------------------- FAIL     [-lt 99]
#+end_src
** other notes
#+begin_src
Exception in thread "Thread-9" java.lang.NullPointerException
        at clj_kafka.new.producer$send.invoke(producer.clj:64)
        at wonko_client.kafka_producer$send.invoke(kafka_producer.clj:38)
        at wonko_client.core$gauge.doInvoke(core.clj:31)
        at clojure.lang.RestFn.invoke(RestFn.java:445)
        at eccentrica.monitoring$register_tuple_stats.invoke(monitoring.clj:61)
        at eccentrica.db.stats$monitor_db_stats.invoke(stats.clj:24)
        at eccentrica.utils.threads$start_daemon$fn__19179.invoke(threads.clj:14)
        at clojure.lang.AFn.run(AFn.java:22)
        at java.lang.Thread.run(Thread.java:745)
#+end_src

* fixes
** don't block on buffer full
- with 10k requests

*** "block.on.buffer.full" "true"
#+begin_src
         0   32294 / 34843    92.68%  92.68%
         1     677 / 34843    1.94%  94.63%
         2     321 / 34843    0.92%  95.55%
         3     207 / 34843    0.59%  96.14%
         4     163 / 34843    0.47%  96.61%
         5     134 / 34843    0.38%  97.00%
         6     115 / 34843    0.33%  97.33%
         7      88 / 34843    0.25%  97.58%
         8      74 / 34843    0.21%  97.79%
         9      70 / 34843    0.20%  97.99%
        10      56 / 34843    0.16%  98.15%
        11      61 / 34843    0.18%  98.33%
        12      56 / 34843    0.16%  98.49%
        13      41 / 34843    0.12%  98.61%
        14      27 / 34843    0.08%  98.68%
#+end_src

*** "block.on.buffer.full" "false"
#+begin_src
         0   31825 / 34724    91.65%  91.65%
         1     718 / 34724    2.07%  93.72%
         2     321 / 34724    0.92%  94.64%
         3     234 / 34724    0.67%  95.32%
         4     185 / 34724    0.53%  95.85%
         5     128 / 34724    0.37%  96.22%
         6      93 / 34724    0.27%  96.49%
         7     112 / 34724    0.32%  96.81%
         8      96 / 34724    0.28%  97.09%
         9      68 / 34724    0.20%  97.28%
        10      73 / 34724    0.21%  97.49%
        11      78 / 34724    0.22%  97.72%
        12      63 / 34724    0.18%  97.90%
        13      65 / 34724    0.19%  98.08%
        14      41 / 34724    0.12%  98.20%
#+end_src

*** "block.on.buffer.full" "false", "total.memory.bytes" (* 1024 1024 120)
#+begin_src
         0   34436 / 36173    95.20%  95.20%
         1     534 / 36173    1.48%  96.67%
         2     257 / 36173    0.71%  97.38%
         3     139 / 36173    0.38%  97.77%
         4     129 / 36173    0.36%  98.13%
         5      77 / 36173    0.21%  98.34%
         6      80 / 36173    0.22%  98.56%
         7      68 / 36173    0.19%  98.75%
         8      58 / 36173    0.16%  98.91%
         9      36 / 36173    0.10%  99.01%
        10      36 / 36173    0.10%  99.11%
        11      35 / 36173    0.10%  99.20%
        12      27 / 36173    0.07%  99.28%
        13      28 / 36173    0.08%  99.36%
        14      23 / 36173    0.06%  99.42%
#+end_src

*** "block.on.buffer.full" "false", "total.memory.bytes" (* 1024 1024 120), future
#+begin_src
         0   34298 / 35206    97.42%  97.42%
         1     254 / 35206    0.72%  98.14%
         2     103 / 35206    0.29%  98.43%
         3      87 / 35206    0.25%  98.68%
         4      56 / 35206    0.16%  98.84%
         5      48 / 35206    0.14%  98.98%
         6      34 / 35206    0.10%  99.07%
         7      40 / 35206    0.11%  99.19%
         8      24 / 35206    0.07%  99.26%
         9      22 / 35206    0.06%  99.32%
        10      13 / 35206    0.04%  99.36%
        11      28 / 35206    0.08%  99.43%
        12      24 / 35206    0.07%  99.50%
        13      17 / 35206    0.05%  99.55%
        14      18 / 35206    0.05%  99.60%
#+end_src
* fully-async numbers
** try 1
==================== WONKO

         0   115482 / 115669    99.84%  99.84%
         5     135 / 115669    0.12%  99.96%
        10      14 / 115669    0.01%  99.97%
        15       3 / 115669    0.00%  99.97%
        20       9 / 115669    0.01%  99.98%
        25       4 / 115669    0.00%  99.98%
        30       1 / 115669    0.00%  99.98%
        35       3 / 115669    0.00%  99.98%
        65       3 / 115669    0.00%  99.99%
        70       2 / 115669    0.00%  99.99%
        85       2 / 115669    0.00%  99.99%
       110       1 / 115669    0.00%  99.99%
       130       5 / 115669    0.00%  100.00%
       170       1 / 115669    0.00%  100.00%
       175       1 / 115669    0.00%  100.00%
       195       1 / 115669    0.00%  100.00%
       200       1 / 115669    0.00%  100.00%
      1100       1 / 115669    0.00%  100.00%

==================== HISTOGRAMS

GB
          0   40618 / 41376    98.17%  98.17%
         5     596 / 41376    1.44%  99.61%
        10      44 / 41376    0.11%  99.71%
        15       6 / 41376    0.01%  99.73%
        20       4 / 41376    0.01%  99.74%
        25       3 / 41376    0.01%  99.75%

                   GB-under-10: 99 --------------------------------------   OK     [-lt 97]
GUT
          0   35513 / 42269    84.02%  84.02%
         5    6308 / 42269    14.92%  98.94%
        10     238 / 42269    0.56%  99.50%
        15      48 / 42269    0.11%  99.62%
        20      25 / 42269    0.06%  99.68%
        25      18 / 42269    0.04%  99.72%

                  GUT-under-10: 98 --------------------------------------   OK     [-lt 90]

** try 2
==================== WONKO

         0   30289 / 33824    89.55%  89.55%
         1    2295 / 33824    6.79%  96.33%
         2     755 / 33824    2.23%  98.57%
         3     275 / 33824    0.81%  99.38%
         4     113 / 33824    0.33%  99.71%
         5      45 / 33824    0.13%  99.85%
         6      18 / 33824    0.05%  99.90%
         7       8 / 33824    0.02%  99.92%
         8       5 / 33824    0.01%  99.94%
         9       8 / 33824    0.02%  99.96%
        10       1 / 33824    0.00%  99.96%
        11       4 / 33824    0.01%  99.98%
        12       1 / 33824    0.00%  99.98%
        13       2 / 33824    0.01%  99.99%
        16       1 / 33824    0.00%  99.99%
        17       1 / 33824    0.00%  99.99%
        20       1 / 33824    0.00%  99.99%
       186       1 / 33824    0.00%  100.00%
       221       1 / 33824    0.00%  100.00%


==================== HISTOGRAMS

GB
          0   11839 / 12130    97.60%  97.60%
         5     256 / 12130    2.11%  99.71%
        10      27 / 12130    0.22%  99.93%
        15       2 / 12130    0.02%  99.95%
        20       2 / 12130    0.02%  99.97%
        40       1 / 12130    0.01%  99.98%

                   GB-under-10: 99 --------------------------------------   OK     [-lt 97]
GUT
          0    9951 / 12368    80.46%  80.46%
         5    2311 / 12368    18.69%  99.14%
        10      88 / 12368    0.71%  99.85%
        15      12 / 12368    0.10%  99.95%
        20       1 / 12368    0.01%  99.96%
       215       4 / 12368    0.03%  99.99%

                  GUT-under-10: 99 --------------------------------------   OK     [-lt 90]
